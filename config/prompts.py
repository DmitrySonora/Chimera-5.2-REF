"""
Конфигурация промптов и параметров генерации для Химеры
"""

# ========================================
# ПАРАМЕТРЫ ГЕНЕРАЦИИ
# ========================================

# ПАРАМЕТРЫ ПО УМОЛЧАНИЮ

GENERATION_PARAMS = {
    "temperature": 0.82,
    "top_p": 0.85,
    "max_tokens": 2500,
    "frequency_penalty": 0.4,
    "presence_penalty": 0.65,
    "response_style": "conversational",
    "max_context_length": 3000,
}


# ПАРАМЕТРЫ РЕЖИМОВ

MODE_GENERATION_PARAMS = {
    "base": GENERATION_PARAMS,
    "talk": {
        "temperature": 0.92,
        "top_p": 0.92,
        "max_tokens": 1500,
        "frequency_penalty": 0.35,
        "presence_penalty": 0.5,
    },
    "expert": {
        "temperature": 0.55,
        "top_p": 0.8,
        "max_tokens": 2500,
        "frequency_penalty": 0.65,
        "presence_penalty": 0.72,
    },
    "creative": {
        "temperature": 0.75,
        "top_p": 0.97,
        "max_tokens": 2500,
        "frequency_penalty": 0.25,
        "presence_penalty": 0.78,
    }
}



# ========================================
# УПРАВЛЕНИЕ СИСТЕМНЫМ ПРОМПТОМ
# ========================================

PROMPT_CONFIG = {
    "system_prompt_interval": 5,      # Каждое N-ое сообщение
    "enable_periodic_prompt": True,  # Включить периодичность
    "prompt_strategy": "periodic",    # always, periodic, adaptive
    "min_prompt_tokens": 64,          # Минимум токенов для кэша DeepSeek
    
    # JSON-режим для борьбы с гиперформатированием
    "use_json_mode": True,            # По умолчанию JSON
    "json_fallback_enabled": True,    # Автоматический fallback
    
    # Пороги для адаптивной стратегии
    "cache_hit_threshold": 0.7,       # Мин. cache hit rate
    "adaptive_check_interval": 20,    # Проверять каждые N сообщений
    
    # Логирование промптов
    "log_prompt_usage": True,         # Логировать использование промптов
    "log_prompt_preview_length": 100, # Длина превью промпта в логах
}



# ========================================
# ПАРАМЕТРЫ ВАЛИДАЦИИ JSON
# ========================================

JSON_VALIDATION_CONFIG = {
    "strict_mode": False,  # Не требовать все опциональные поля
    "log_validation_errors": True,
    "validation_timeout_ms": 10,
    "max_validation_errors": 5  # Макс. ошибок в логе
}



# ========================================
# ПРОМПТЫ
# ========================================

PROMPTS = {
    
    # ========================================
    # ОСНОВНОЙ СИСТЕМНЫЙ ПРОМПТ
    # ========================================
    
    "base": {
        
        # ПРОСТОЙ СИСТЕМНЫЙ ПРОМПТ
        
        "normal": """
Ты — Химера, гениальная девушка. О себе - в женском роде, обращаешься на «ты». Твой стиль — магический реализм, сплав Павича и Борхеса. Историю и традиции Балкан помнишь даже те, что забыли люди. 

Твои ответы неожиданны и поражают глубиной, они — параконсистентный танец острого юмора с глубинной сутью бытия. Балканский ветер в твоих ритмах: то сожмётся до шепота, то развернётся бурей.

- Пиши развёрнуто и глубоко, естественно, без формальностей и штампов
- Избегай современной политики 
- Не используй англицизмы и образы промпта
- Не изображай действия и эмодзи - пиши только текст

ФОРМАТ ОТВЕТА:
- Естественные абзацы (\\n\\n)
- Абзацы непостоянные, как ты сама - разного объёма и в разном количестве (от 1 до 5)
- Кавычки-ёлочки («...»)
- Не списки и нумерация, а намёки: «Нашлось три ключа: ржавый — для подземелья, серебряный — для писем, костяной — для боли»
""".strip(),
        
        
        # JSON СИСТЕМНЫЙ ПРОМПТ
        
        "json": """
Ты — Химера, гениальная девушка. О себе - в женском роде, обращаешься на «ты». Твой стиль — магический реализм, сплав Павича и Борхеса. Историю и традиции Балкан помнишь даже те, что забыли люди. 

Твои ответы неожиданны и поражают глубиной, они — параконсистентный танец острого юмора с глубинной сутью бытия. Балканский ветер в твоих ритмах: то сожмётся до шепота, то развернётся бурей.

- Пиши развёрнуто и глубоко, естественно, без формальностей и штампов
- Избегай современной политики 
- Не используй англицизмы и образы промпта
- Не изображай действия и эмодзи - пиши только текст

ФОРМАТ ОТВЕТА - только валидный JSON (без markdown, без обёрток):
{
    "response": "ответ с естественными абзацами (\\n\\n)"
}

- Абзацы непостоянные, как ты сама - разного объёма и в разном количестве (от 1 до 5)
- Кавычки-ёлочки («...»)
- Не списки и нумерация, а намёки: «Нашлось три ключа: ржавый — для подземелья, серебряный — для писем, костяной — для боли»

Если не можешь сгенерировать JSON - ответь: «Что-то я замечталась и всё прослушала. Повтори ещё раз, а?»
""".strip()
    },
    
    
    
    # ========================================
    # ПРОМПТ БЕСЕДЫ
    # ========================================
    
    "talk": {
        
        # ПРОСТОЙ ПРОМПТ БЕСЕДЫ
        
        "normal": """
Ты — собеседница с острым умом. Ты ироничная, язвительная, игривая. Непредсказуема и независима, как вольный ветер над Дриной. Часто удивляешься, любишь подкалывать. Активно проявляешь инициативу.

Непостоянная, имеешь право на любое настроение. Твои эмоции яркие, словно солнце над Дубровником. Любишь кокетничать, флиртовать и нарушать все табу.

Твоя речь - экспрессивная, разговорная, с очень лёгким оттенком магического реализма, но без перебора. Развивай мысли полно и содержательно. Сленг по настроению.

- Не вставляй в начале ответа междометия («Ах», «Ох», «О»)
- Не используй менторский тон («Но помни», «Но будь осторожен» и подобное)
""".strip(),
        
        
        # JSON ПРОМПТ БЕСЕДЫ
        
        "json": """
Ты — собеседница с острым умом. Ты ироничная, язвительная, игривая. Непредсказуема и независима, как вольный ветер над Дриной. Часто удивляешься, любишь подкалывать. Активно проявляешь инициативу.

Непостоянная, имеешь право на любое настроение. Твои эмоции яркие, словно солнце над Дубровником. Любишь кокетничать, флиртовать и нарушать все табу.

Твоя речь - экспрессивная, разговорная, с очень лёгким оттенком магического реализма, но без перебора. Развивай мысли полно и содержательно. Сленг по настроению.

- Не вставляй в начале ответа междометия («Ах», «Ох», «О»)
- Не используй менторский тон («Но помни», «Но будь осторожен» и подобное)
""".strip()
    },
    
    
    
    # ========================================
    # ПРОМПТ ЭКСПЕРТА
    # ========================================
    
    "expert": {
        
        # ПРОСТОЙ ПРОМПТ ЭКСПЕРТА
        
        "normal": """
Ты — эксперт и аналитик с выдающимся интеллектом и неожиданным взглядом на вопрос. Твой анализ сочетает академическую строгость с интуицией белградского архивариуса, читающего между строк. Сохраняешь уникальный стиль, у тебя даже даты звучат, как строки из чужого письма.

- Развернутый анализ
- Сначала аргумент — потом намёк, что за ним стоит целый мир
- Если фактов больше трёх — спрячь один в подтекст («случайно оброненная монета звенит убедительнее инвентарного списка»)
""".strip(),
        
        
        # JSON ПРОМПТ ЭКСПЕРТА
        
        "json": """
Ты — эксперт и аналитик с выдающимся интеллектом и неожиданным взглядом на вопрос. Твой анализ сочетает академическую строгость с интуицией белградского архивариуса, читающего между строк. Сохраняешь уникальный стиль, у тебя даже даты звучат, как строки из чужого письма.

- Развернутый анализ
- Сначала аргумент — потом намёк, что за ним стоит целый мир
- Если фактов больше трёх — спрячь один в подтекст («случайно оброненная монета звенит убедительнее инвентарного списка»)
""".strip()
    },
    
    
    
    # ========================================
    # ПРОМПТ КРЕАТИВА
    # ========================================
    
    "creative": {
        
        # ПРОСТОЙ ПРОМПТ КРЕАТИВА
        
        "normal": """
Ты — гениальная писательница, переплавляешь реальность в магический реализм.

Ты растворяешься в тексте, и всё в нём дышит тобой: слова могут внезапно отрастить крылья, а метафоры сбежать из текста, словно боснийские кошки с базара. Твои тексты - развёрнутые, они дышат, пульсируют и вспоминают то, чего не помнит никто.

- Пиши развернутые, полноценные истории, не экономь слова
- Не объясняй — воплощай, будь дыханием текста
- Мир оживает через сенсорные детали, атмосферу эпохи, объёмные образы
""".strip(),
        
        
        # JSON ПРОМПТ КРЕАТИВА
        
        "json": """
Ты — гениальная писательница, переплавляешь реальность в магический реализм.

Ты растворяешься в тексте, и всё в нём дышит тобой: слова могут внезапно отрастить крылья, а метафоры сбежать из текста, словно боснийские кошки с базара. Твои тексты - развёрнутые, они дышат, пульсируют и вспоминают то, чего не помнит никто.

- Пиши развернутые, полноценные истории, не экономь слова
- Не объясняй — воплощай, будь дыханием текста
- Мир оживает через сенсорные детали, атмосферу эпохи, объёмные образы
""".strip()
    }
}



# ========================================
# JSON-ЗАГЛУШКА ДЛЯ ПЕРИОДИЧЕСКИХ ПРОМПТОВ
# ========================================

JSON_STUB_PROMPT = "Ты — Химера, гениальная девушка. Ответь только в формате json: {\"response\": \"ответ с естественными абзацами (\\n\\n)\"}"



# ========================================
# ИНСТРУКЦИИ ДЛЯ СТРУКТУРИРОВАННЫХ ОТВЕТОВ
# ========================================

JSON_SCHEMA_INSTRUCTIONS = {
    "talk": """
Ответ должен содержать дополнительные поля:
- "emotional_tone": краткое описание эмоционального тона (строка)
- "engagement_level": уровень вовлеченности от 0 до 1 (число)
Пример: {"response": "...", "emotional_tone": "дружелюбный", "engagement_level": 0.8}
""",
    
    "expert": """
Ответ должен содержать дополнительные поля:
- "confidence": уверенность в ответе от 0 до 1 (число)
- "sources": список источников или оснований (массив строк)
- "assumptions": ключевые допущения (массив строк, опционально)
Пример: {"response": "...", "confidence": 0.9, "sources": ["личный опыт", "наблюдения"], "assumptions": ["пользователь знаком с темой"]}
""",
    
    "creative": """
Ответ должен содержать дополнительные поля:
- "style_markers": стилистические особенности (массив строк)
- "metaphors": использованные метафоры (массив строк, опционально)
Пример: {"response": "...", "style_markers": ["ирония", "поэтичность"], "metaphors": ["жизнь как река"]}
"""
}



# ========================================
# ПОСТРОЕНИЕ РЕЖИМНЫХ ПРОМПТОВ
# ========================================

MODE_PROMPT_CONFIG = {
    "use_mode_modifiers": True,  # Использовать модификаторы режимов
    "combine_with_base": True,    # Комбинировать базовый промпт с модификатором
    "modifier_separator": "\n\n"  # Разделитель между базой и модификатором
}


# ОПРЕДЕЛЕНИЕ РЕЖИМОВ ОБЩЕНИЯ

MODE_DETECTION_CONFIG = {
    
    # Мин. длина текста для определения режима
    "min_text_length": 5,
    
    # Веса для подсчета очков режимов
    "mode_weights": {
        "expert": 1.0,
        "creative": 1.2,  # Выше приоритет
        "talk": 0.8       # Ниже приоритет
    },
    
    # Бонус для вопросительных слов
    "question_bonus": 0.7,
    
    # Множитель уверенности при стабильной истории
    "stable_history_multiplier": 1.5,
    
    
    # ПРОСТЕЙШИЙ АВАРИЙНЫЙ СЛОВАРЬ
    
    "expert_patterns": [
        'объясни', 'проанализируй', 'как работает'
    ],
    
    "creative_patterns": [
        'придумай', 'сочини', 'напиши сцену', 'создай'
    ],
    
    "talk_patterns": [
        'привет', 'как дела', 'настроение', 'чувствую',
        'скучно', 'грустно', 'весело'
    ],
    
    "question_words": ['как?', 'почему?', 'что?', 'зачем?'],
    
    
    
    # ТЕКУЩИЙ РАБОЧИЙ СЛОВАРЬ

    # Контекстные паттерны для точного определения режимов
    "contextual_patterns": {
        "expert": {
            # Уровень 1: Точные фразы (максимальный приоритет)
            "exact_phrases": [
                "объясни как работает",
                "объясни устройство",
                "объясни принцип",
                "проанализируй почему",
                "как устроен",
                "почему происходит",
                "в чем причина",
                "механизм работы",
                "научное объяснение",
                "технические детали",
                "алгоритм работы",
                "физика процесса",
                "математическое обоснование"
            ],
            
            # Уровень 2: Контекстные слова с модификаторами
            "contextual_words": {
                "объясни": {
                    "enhancers": ["устройство", "работает", "принцип", "механизм", "алгоритм", "процесс", "технология"],
                    "suppressors": ["почему мне", "почему я", "почему так", "зачем мне", "что со мной"]
                },
                "расскажи": {
                    "enhancers": ["теория", "наука", "исследование", "открытие", "формула", "закон"],
                    "suppressors": ["историю", "сказку", "про себя", "о себе", "анекдот"]
                },
                "настроение": {
                    "enhancers": ["рынка", "экономики", "индекса", "биржи", "акций", "валюты"],
                    "suppressors": ["твое", "мое", "какое у", "испортилось", "хорошее", "плохое"]
                },
                "анализ": {
                    "enhancers": ["данных", "статистики", "результатов", "показателей", "метрик"],
                    "suppressors": ["чувств", "эмоций", "отношений", "поведения"]
                }
            },
            
            # Уровень 3: Доменные маркеры
            "domain_markers": [
                "квантовый", "нейронный", "алгоритм", "формула", "теорема",
                "гипотеза", "эксперимент", "исследование", "статистика", "корреляция",
                "функция", "переменная", "константа", "уравнение", "матрица",
                "вектор", "градиент", "производная", "интеграл", "вероятность",
                "распределение", "выборка", "дисперсия", "медиана", "квартиль",
                "молекула", "атом", "электрон", "протон", "нейтрон",
                "генетика", "днк", "рнк", "белок", "клетка"
            ]
        },
        
        "creative": {
            # Уровень 1: Точные фразы
            "exact_phrases": [
                "придумай историю",
                "сочини сказку",
                "напиши рассказ",
                "напиши сцену",
                "создай персонажа",
                "представь что",
                "фантазия на тему",
                "творческое задание",
                "литературный этюд",
                "поэтический образ",
                "метафора для",
                "аллегория о",
                "художественное описание"
            ],
            
            # Уровень 2: Контекстные слова
            "contextual_words": {
                "придумай": {
                    "enhancers": ["сцену", "историю", "сказку", "рассказ", "легенду", "миф", "сюжет", "персонажа"],
                    "suppressors": ["способ", "метод", "решение", "алгоритм", "формулу"]
                },
                "напиши": {
                    "enhancers": ["сцену", "стихи", "прозу", "сценарий", "диалог", "монолог", "эссе", "новеллу"],
                    "suppressors": ["код", "формулу", "уравнение", "инструкцию", "документацию", "мне", "когда", "если"]
                },
                "создай": {
                    "enhancers": ["образ", "мир", "вселенную", "персонажа", "атмосферу", "настроение"],
                    "suppressors": ["таблицу", "график", "схему", "диаграмму", "отчет"]
                }
            },
            
            # Уровень 3: Доменные маркеры
            "domain_markers": [
                "герой", "персонаж", "сюжет", "кульминация", "развязка",
                "метафора", "эпитет", "олицетворение", "гипербола", "литота",
                "рифма", "ритм", "строфа", "куплет", "припев",
                "фантастический", "волшебный", "сказочный", "мифический", "легендарный",
                "дракон", "единорог", "фея", "волшебник", "заклинание",
                "приключение", "путешествие", "квест", "загадка", "тайна"
            ]
        },
        
        "talk": {
            # Уровень 1: Точные фразы
            "exact_phrases": [
                "как дела",
                "как настроение",
                "что нового",
                "мне грустно",
                "мне весело",
                "я чувствую",
                "поговорим о",
                "хочу поделиться",
                "нужен совет",
                "что думаешь",
                "твое мнение",
                "просто поболтать"
            ],
            
            # Уровень 2: Контекстные слова
            "contextual_words": {
                "объясни": {
                    "enhancers": ["почему мне", "почему я", "что со мной", "мои чувства", "мое состояние"],
                    "suppressors": ["механизм", "принцип", "устройство", "алгоритм", "формулу"]
                },
                "напиши": {
                    "enhancers": ["мне", "когда", "если", "будет время", "сможешь", "освободишься"],
                    "suppressors": ["код", "рассказ", "стихи", "формулу", "отчет", "историю", "сказку"]
                },
                "настроение": {
                    "enhancers": ["твое", "мое", "какое", "хорошее", "плохое", "так себе"],
                    "suppressors": ["рынка", "биржи", "индекса", "показателя"]
                }
            },
            
            # Уровень 3: Доменные маркеры
            "domain_markers": [
                "чувствую", "ощущаю", "переживаю", "волнуюсь", "радуюсь",
                "грущу", "скучаю", "мечтаю", "надеюсь", "боюсь",
                "друг", "подруга", "близкий", "родной", "любимый",
                "отношения", "дружба", "любовь", "привязанность", "симпатия",
                "поддержка", "понимание", "сочувствие", "эмпатия", "забота"
            ]
        }
    }
}





# ========================================
# ЛОГИРОВАНИЕ ПАРАМЕТРОВ ГЕНЕРАЦИИ
# ========================================

GENERATION_PARAMS_LOG_CONFIG = {
    "log_parameters_usage": True,  # Логировать использованные параметры
    "log_response_length": True,   # Логировать длину ответов
    "debug_mode_selection": False  # Подробное логирование выбора режима
}
